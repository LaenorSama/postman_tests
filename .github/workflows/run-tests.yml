name: Run Postman Tests

# переменные окружения
env:
  ENDPOINT: ${{ secrets.ENDPOINT }}
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  TOKEN: ${{ secrets.TOKEN }}
  ALLURE_JOB_RUN_ID: ${{ github.event.inputs.ALLURE_JOB_RUN_ID }}
  ALLURE_RESULTS: "./out/allure-results"
  BROWSER: ${{ inputs.BROWSER || 'OperaGX' }}
  OS: ${{ inputs.OS || 'Win_11' }}
  BRANCH: ${{ github.ref_name }}

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      BROWSER:
        description: Browser
        required: false
        default: "OperaGX"
      OS:
        description: OS
        required: false
        default: "Win_11"
      ALLURE_JOB_RUN_ID:
        description: "ALLURE_JOB_RUN_ID - service parameter (leave blank)"
        required: false
        default: ""
      ALLURE_USERNAME:
        description: "ALLURE_USERNAME - service parameter (leave blank)"
        required: false
        default: ""

permissions: write-all

jobs:
  test:
    name: Run tests and generate Allure Report
    runs-on: ubuntu-latest

    steps:
      # Шаг 1: чекаут репозитория
      - name: Checkout repo
        uses: actions/checkout@v4.2.2
        
      # Шаг 2: Установка Node.js и зависимостей
      - name: Set up Node 20
        uses: actions/setup-node@v4.1.0
        with:
          node-version: 20
          cache: npm

      - name: Install npm dependencies
        run: npm install

      # Шаг 3: Установка Newman и Allure Reporter
      - name: Install Newman and Allure Reporter
        run: |
          npm install -g newman
          npm install -g newman-reporter-allure
        
      # Устанавливаем allurectl
      - name: Install allurectl
        uses: allure-framework/setup-allurectl@v1
        with:
          allure-endpoint: ${{ env.ENDPOINT }}
          allure-token: ${{ env.TOKEN }}
          allure-project-id: ${{ env.PROJECT_ID }}

      - name: Remove old directories
        run: |
          rm -rf allure-results .allure

      - name: Create Allure results directory
        run: |
          mkdir -p ${{ env.ALLURE_RESULTS }}
          chmod -R 777 ${{ env.ALLURE_RESULTS }}

      - name: Check if allure-results directory is empty
        run: ls -alh ${{ env.ALLURE_RESULTS }}

      #- name: Run Postman Collection
      #  run: |
      #    allurectl watch "newman run postman/collection.json \
      #      --env-var ENDPOINT=${{ env.ENDPOINT }} \
      #      --env-var TOKEN=${{ env.TOKEN }} \
      #      -r allure,cli,junit \
      #      --reporters allure,cli,junit \
      #      --reporter-allure-export ${{ env.ALLURE_RESULTS }}"
      #  continue-on-error: true
      - name: Run Postman Collection
        run: |
          newman run postman/collection.json \
            --env-var ENDPOINT=${{ env.ENDPOINT }} \
            --env-var TOKEN=${{ env.TOKEN }} \
            -r allure \
            --reporter-allure-export ${{ env.ALLURE_RESULTS }}

            
      - name: Check Allure results directory after run
        run: ls -alh ${{ env.ALLURE_RESULTS }}
